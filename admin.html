<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Ultra - Web Search IA</title>
    <style>
        :root {
            --primary: #2d5a27;
            --bg: #f4f7f4;
        }

        body {
            font-family: system-ui;
            background: var(--bg);
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
        }

        .main-layout {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            width: 100%;
            max-width: 1200px;
        }

        /* Mobile */
        @media (max-width: 768px) {
            .main-layout {
                grid-template-columns: 1fr;
            }
        }

        .card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.05);
        }
        .card h2, .card h3 {
            color: var(--primary);
        }

        label {
            font-weight: bold;
            margin-top: 10px;
            display: block;
        }



        input,
        textarea,
        select {
            width: 100%;
            padding: 12px;
            margin: 8px 0;
            border: 1px solid #ddd;
            border-radius: 8px;
            box-sizing: border-box;
        }

        .bloco {
            background: #f9f9f9;
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            border-left: 4px solid var(--primary);
            position: relative;
        }

        #preview-area {
            border: 2px dashed #ccc;
            height: fit-content;
            position: sticky;
            top: 20px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .preview-content img {
            max-width: 100%;
            border-radius: 8px;
            margin: 10px 0;
            transition: 0.5s;
        }

        .btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            width: 100%;
            margin-top: 10px;
            transition: 0.3s;
        }

        .btn-add {
            background: #8da08b;
            margin-bottom: 5px;
        }

        .btn-del {
            background: #ff4d4d;
            color: white;
            border: none;
            padding: 5px 10px;
            cursor: pointer;
            border-radius: 4px;
            float: right;
        }

        /* Loading da IA */
        #ia-status {
            font-size: 0.9rem;
            color: #666;
            margin-bottom: 10px;
            font-style: italic;
            min-height: 20px;
        }

        .loading-pulse {
            animation: pulse 1.5s infinite;
            color: var(--primary);
            font-weight: bold;
        }

        @keyframes pulse {
            0% {
                opacity: 0.5;
            }

            50% {
                opacity: 1;
            }

            100% {
                opacity: 0.5;
            }
        }

        .post-item {
            background: #fff;
            padding: 15px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .stats {
            font-size: 0.8rem;
            color: #666;
        }
    </style>
</head>

<body>

    <div class="main-layout">
        <div class="card">
            <h2 id="form-title">Editor Conectado √† Web - Low Waste </h2>

            <input type="password" id="adminPass" placeholder="Senha de Acesso">

            <label>Sobre o que √© o post?</label>
            <input type="text" id="postTitle" placeholder="Digite o t√≠tulo..." oninput="iniciarBuscaInteligente()">

            <div id="ia-status"></div>

            <label>Categoria Sugerida:</label>
            <select title="categorias" id="postCat" onchange="updatePreview()">
                <option value="Dicas">üåø Dicas Gerais</option>
                <option value="Cozinha">üçé Cozinha Sustent√°vel</option>
                <option value="Horta">üåª Horta & Jardim</option>
                <option value="Banheiro">üß¥ Banheiro Eco</option>
            </select>

            <label>Capa (Autom√°tica):</label>
            <div style="display:flex; gap:5px;">
                <input type="text" id="postThumb" placeholder="URL da imagem..." oninput="updatePreview()">
                <button class="btn" style="width: 50px; margin:8px 0;" onclick="iniciarBuscaInteligente(true)"
                    title="Nova Imagem">IR</button>
            </div>

            <div id="blocks-container"></div>

            <button class="btn btn-add" onclick="addBlock('texto')">+ Par√°grafo</button>
            <button class="btn btn-add" onclick="addBlock('subtitulo')">+ Subt√≠tulo</button>
            <button class="btn btn-add" onclick="addBlock('imagem')">+ Imagem Interna</button>

            <button id="btnSave" class="btn">SALVAR POST</button>
            <button id="btnCancel" class="btn" style="background:#888; display:none;"
                onclick="location.reload()">CANCELAR EDI√á√ÉO</button>

            <hr>
            <h3>Gerenciar Posts</h3>
            <div id="manager-list">Carregando...</div>
        </div>

        <div class="card" id="preview-area">
            <h3>Preview</h3>
            <div id="real-time-preview" class="preview-content">
                <h1 id="pre-title" style="color:var(--primary)">T√≠tulo aqui...</h1>
                <div id="pre-thumb"></div>
                <div id="pre-body"></div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, updateDoc, getDoc, serverTimestamp, query, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyB3IehrenMKz8uJSgea3EaiIhlIDEAtrQw",
            authDomain: "blog-low-wast.firebaseapp.com",
            projectId: "blog-low-wast",
            storageBucket: "blog-low-wast.firebasestorage.app",
            messagingSenderId: "85524783938",
            appId: "1:85524783938:web:c5904c60900c95dc909edb"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        let editId = null;

        // ============================================
        // üß† C√âREBRO DA IA (WEB SEARCH)
        // ============================================

        // ‚ö†Ô∏è IMPORTANTE: Crie uma conta no https://unsplash.com/developers e pegue sua Access Key gratuita.
        // √â gr√°tis e permite 50 buscas por hora.
        const UNSPLASH_ACCESS_KEY = "Woz_GuCYmXfHNHWnzruw2zBTw2S7cBEjUvZFAuQxTQU"; // <--- COLAR SUA CHAVE AQUI

        let tempoDigitacao; // Para n√£o buscar a cada letra, e sim quando parar de digitar

        window.iniciarBuscaInteligente = (forcar = false) => {
            updatePreview();
            const titulo = document.getElementById('postTitle').value;
            const status = document.getElementById('ia-status');

            if (!titulo && !forcar) return;

            // Limpa o timer anterior (debounce)
            clearTimeout(tempoDigitacao);

            // Espera 1 segundo ap√≥s o usu√°rio parar de digitar
            tempoDigitacao = setTimeout(async () => {
                status.innerHTML = `<span class="loading-pulse">üîé Pesquisando na web imagens para: "${titulo}"...</span>`;

                // L√≥gica: Se o t√≠tulo for muito curto (ex: "."), pesquisa "Natureza" ou "Abstrato"
                let termoBusca = titulo.length < 3 ? "nature sustainability abstract" : titulo;

                // Adiciona "minimalist" ou "nature" para tentar manter o estilo do blog
                termoBusca += " minimalist nature";

                try {
                    // Faz a chamada real para a API do Unsplash
                    const response = await fetch(`https://api.unsplash.com/search/photos?page=1&query=${termoBusca}&per_page=1&orientation=landscape&client_id=${UNSPLASH_ACCESS_KEY}`);

                    if (response.ok) {
                        const data = await response.json();
                        if (data.results.length > 0) {
                            const imgUrl = data.results[0].urls.regular;
                            document.getElementById('postThumb').value = imgUrl;
                            status.innerHTML = `‚úÖ Encontrei uma imagem perfeita!`;
                            updatePreview();

                            // Sugerir categoria baseada no texto (b√°sico)
                            if (titulo.match(/cozinha|receita|comida/i)) document.getElementById('postCat').value = "Cozinha";
                            else if (titulo.match(/horta|planta|jardim/i)) document.getElementById('postCat').value = "Horta";
                            else if (titulo.match(/banho|pele|sabonete/i)) document.getElementById('postCat').value = "Banheiro";

                        } else {
                            status.innerHTML = `‚ùå Nada encontrado. Tentando termo gen√©rico...`;
                            // Fallback se n√£o achar nada
                            document.getElementById('postThumb').value = "https://images.unsplash.com/photo-1542601906990-b4d3fb778b09?w=800";
                            updatePreview();
                        }
                    } else {
                        // Se der erro (ex: sem chave de API), usa placeholder
                        console.error("Erro API Unsplash (Provavelmente falta a Key)");
                        status.innerHTML = `‚ö†Ô∏è Sem chave de API. Usando imagem aleat√≥ria.`;
                        document.getElementById('postThumb').value = "https://source.unsplash.com/random/800x600/?" + termoBusca;
                        updatePreview();
                    }
                } catch (error) {
                    console.error(error);
                }
            }, 1000); // 1000ms = 1 segundo de espera
        };

        // ============================================
        // SISTEMA DO ADMIN (CRUD)
        // ============================================

        window.addBlock = (tipo, valor = "") => {
            const div = document.createElement('div');
            div.className = 'bloco'; div.dataset.tipo = tipo;
            div.innerHTML = `
            <button class="btn-del" onclick="this.parentElement.remove(); updatePreview()">X</button>
            <small>${tipo.toUpperCase()}</small>
            ${tipo === 'texto' ? `<textarea class="block-val" oninput="updatePreview()">${valor}</textarea>` : `<input type="text" class="block-val" value="${valor}" oninput="updatePreview()">`}
        `;
            document.getElementById('blocks-container').appendChild(div);
            updatePreview();
        }

        window.updatePreview = () => {
            document.getElementById('pre-title').innerText = document.getElementById('postTitle').value || "T√≠tulo aqui...";
            const thumb = document.getElementById('postThumb').value;
            document.getElementById('pre-thumb').innerHTML = thumb ? `<img src="${thumb}">` : "";

            let html = "";
            document.querySelectorAll('.bloco').forEach(b => {
                const val = b.querySelector('.block-val').value;
                if (b.dataset.tipo === 'texto') html += `<p>${val}</p>`;
                else if (b.dataset.tipo === 'subtitulo') html += `<h3>${val}</h3>`;
                else if (b.dataset.tipo === 'imagem') html += `<img src="${val}">`;
            });
            document.getElementById('pre-body').innerHTML = html;
        }

        document.getElementById('btnSave').onclick = async () => {
            if (document.getElementById('adminPass').value !== "0106ma@") return alert("Senha Incorreta!");

            const conteudo = Array.from(document.querySelectorAll('.bloco')).map(el => ({
                tipo: el.dataset.tipo, valor: el.querySelector('.block-val').value
            }));

            const postData = {
                titulo: document.getElementById('postTitle').value,
                categoria: document.getElementById('postCat').value,
                imagem: document.getElementById('postThumb').value,
                status: document.getElementById('postStatus').value,
                conteudo: conteudo,
                data: serverTimestamp()
            };

            try {
                if (editId) {
                    await updateDoc(doc(db, "posts", editId), postData);
                    alert("Atualizado!");
                } else {
                    postData.views = 0;
                    await addDoc(collection(db, "posts"), postData);
                    alert("Criado!");
                }
                location.reload();
            } catch (e) { alert("Erro: " + e.message); }
        }

        window.startEdit = async (id) => {
            const snap = await getDoc(doc(db, "posts", id));
            const p = snap.data(); editId = id;
            document.getElementById('postTitle').value = p.titulo;
            document.getElementById('postThumb').value = p.imagem;
            document.getElementById('postCat').value = p.categoria;
            document.getElementById('postStatus').value = p.status;
            document.getElementById('btnSave').innerText = "ATUALIZAR";
            document.getElementById('btnCancel').style.display = "block";
            document.getElementById('blocks-container').innerHTML = "";
            if (p.conteudo) p.conteudo.forEach(b => addBlock(b.tipo, b.valor));
            window.scrollTo(0, 0);
        }

        async function loadManager() {
            const q = query(collection(db, "posts"), orderBy("data", "desc"));
            const snap = await getDocs(q);
            const list = document.getElementById('manager-list');
            list.innerHTML = "";
            snap.forEach(d => {
                const p = d.data();
                list.innerHTML += `
                <div class="post-item">
                    <div><b>${p.titulo}</b><br><span class="stats">üëÅÔ∏è ${p.views || 0} | üö© ${p.status}</span></div>
                    <div><button onclick="startEdit('${d.id}')">‚úèÔ∏è</button>
                    <button onclick="deleteDoc(doc(db,'posts','${d.id}')).then(()=>location.reload())">üóëÔ∏è</button></div>
                </div>`;
            });
        }
        loadManager();
    </script>
</body>

</html>